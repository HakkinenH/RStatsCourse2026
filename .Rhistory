install_github("ropensci/CoordinateCleaner")
install.packages(countrycode)
install.packages("countrycode")
install.packages("rnaturalearthdata")
install.packages("mapview")
install.packages("sdm")
install.packages("biomod2")
install.packages("gstat")
install.packages("RColorBrewer")
install.packages("lattice")
install.packages("spThin")
install.packages("geosphere")
install.packages("SDMTools")
library(wdpar)
library(sf)
library(dplyr)
library(ggmap)
library(rgbif)
library(devtools)
library(CoordinateCleaner)
library(countrycode)
library(mapview)
library(climateR)
library(leaflet)
library(RColorBrewer)
library(raster)
library(biomod2)
install_github("ropensci/CoordinateCleaner")
install.packages("mda")
install.packages("gam")
install.packages("earth")
install.packages("maxnet")
install.packages("randomForest")
install.packages("xgboost")
# load packages
library(wdpar)
library(sf)
library(dplyr)
library(ggmap)
library(rgbif)
library(devtools)
library(CoordinateCleaner)
library(countrycode)
library(mapview)
library(climateR)
library(leaflet)
library(RColorBrewer)
library(raster)
library(biomod2)
library(rgee)
library(googledrive)
library(remotes)
Sys.setenv("RETICULATE_PYTHON" = "C:/Users/Henry/AppData/Local/r-miniconda/bin/python3")
#C:\Users\Henry\AppData\Local\r-miniconda\envs\r-reticulate
Sys.setenv("EARTHENGINE_GCLOUD" = "C:/Users/Henry/AppData/Local/Google/Cloud SDK")
# 4 Install rgee Python dependencies
ee_install()
Sys.setenv("RETICULATE_PYTHON" = "C:/Users/Henry/AppData/Local/r-miniconda/")
#C:\Users\Henry\AppData\Local\r-miniconda\envs\r-reticulate
Sys.setenv("EARTHENGINE_GCLOUD" = "C:/Users/Henry/AppData/Local/Google/Cloud SDK")
# 4 Install rgee Python dependencies
ee_install()
?ee_clean_pyenv
Sys.setenv("RETICULATE_PYTHON" = "C:/Users/Henry/AppData/Local/NA/")
#C:\Users\Henry\AppData\Local\r-miniconda\envs\r-reticulate
Sys.setenv("EARTHENGINE_GCLOUD" = "C:/Users/Henry/AppData/Local/Google/Cloud SDK")
# 4 Install rgee Python dependencies
ee_install()
Sys.setenv("RETICULATE_PYTHON" = "C:/Users/Henry/AppData/Local/NA/")
#C:\Users\Henry\AppData\Local\r-miniconda\envs\r-reticulate
Sys.setenv("EARTHENGINE_GCLOUD" = "C:/Users/Henry/AppData/Local/Google/Cloud SDK")
# 4 Install rgee Python dependencies
ee_install()
library(rgee)
library(googledrive)
library(remotes)
Sys.setenv("RETICULATE_PYTHON" = "C:/Users/Henry/AppData/Local/NA/")
#C:\Users\Henry\AppData\Local\r-miniconda\envs\r-reticulate
Sys.setenv("EARTHENGINE_GCLOUD" = "C:/Users/Henry/AppData/Local/Google/Cloud SDK")
# 4 Install rgee Python dependencies
ee_install()
Sys.setenv("RETICULATE_PYTHON" = "C:/Users/Henry/AppData/Local/r-miniconda")
#C:\Users\Henry\AppData\Local\r-miniconda\envs\r-reticulate
Sys.setenv("EARTHENGINE_GCLOUD" = "C:/Users/Henry/AppData/Local/Google/Cloud SDK")
# 4 Install rgee Python dependencies
ee_install()
ee_clean_pyenv()
ee_install()
ee_clean_pyenv()
HOME <- Sys.getenv("HOME")
HOME
Sys.setenv("RETICULATE_PYTHON" = "C:/Users/Henry/Documents/r-miniconda")
ee_install()
library(rgee)
library(googledrive)
library(remotes)
### INSTALL SECCTION
# Get the username
HOME <- Sys.getenv("HOME")
Sys.setenv("RETICULATE_PYTHON" = "C:/Users/Henry/Documents/r-miniconda")
#C:\Users\Henry\AppData\Local\r-miniconda\envs\r-reticulate
Sys.setenv("EARTHENGINE_GCLOUD" = "C:/Users/Henry/AppData/Local/Google/Cloud SDK")
# 4 Install rgee Python dependencies
ee_clean_pyenv()
ee_install()
library(rgee)
library(reticulate)
earthengine_python <- Sys.getenv("EARTHENGINE_PYTHON", unset = NA)
earthengine_python
Sys.setenv(RETICULATE_PYTHON = earthengine_python)
reticulate::py_config()
library(rgee)
library(googledrive)
library(remotes)
library(reticulate)
ee_install()
library(rgee)
library(googledrive)
library(remotes)
HOME <- Sys.getenv("HOME")
use_python("C:/Users/Henry/Documents/r-miniconda")
library(rgee)
library(reticulate)
use_python("C:/Users/Henry/Documents/r-miniconda")
ee_install()
?install_miniconda
?ee_install
use_python("C:/Users/Henry/Documents/r-miniconda/envs/r-reticulate")
library(rgee)
library(googledrive)
library(remotes)
ee_check()
ee_clean_pyenv()
ee_check()
Sys.setenv("RETICULATE_PYTHON" = "C:/Users/Henry/Documents/r-miniconda")
#C:\Users\Henry\AppData\Local\r-miniconda\envs\r-reticulate
Sys.setenv("EARTHENGINE_GCLOUD" = "C:/Users/Henry/AppData/Local/Google/Cloud SDK")
ee_check()
use_python("C:/Users/Henry/Documents/r-miniconda/")
library(reticulate)
use_python("C:/Users/Henry/Documents/r-miniconda/")
ee_check()
ee_Initialize(project = " ee-hhakk2024")
use_python("C:/Users/Henry/Documents/r-miniconda/envs/rgee")
library(rgee)
library(reticulate)
reticulate::py_config()
use_python("C:/Users/Henry/Documents/r-miniconda/envs/rgee")
library(rgee)
library(googledrive)
library(remotes)
use_python("C:/Users/Henry/Documents/r-miniconda/envs/rgee")
library(reticulate)
use_python("C:/Users/Henry/Documents/r-miniconda/envs/rgee")
ee_clean_pyenv()
ee_check()
ee_check()
ee_check
earthengine_python <- Sys.getenv("EARTHENGINE_PYTHON", unset = NA)
earthengine_python
if (!is.na(earthengine_python))
Sys.setenv(RETICULATE_PYTHON = earthengine_python)
ee_check_python(quiet = quiet)
ee_check_python(quiet = F)
ee_check_python_packages(quiet = F)
use_python("C:/Users/Henry/Documents/r-miniconda/")
library(rgee)
library(googledrive)
library(remotes)
python_version = "3.10"
ee_install(
py_env = "rgee",
earthengine_version = ee_version(),
python_version = "3.10",
confirm = interactive()
)
earthengine_python <- Sys.getenv("EARTHENGINE_PYTHON", unset = NA)
if (!is.na(earthengine_python))
Sys.setenv(RETICULATE_PYTHON = earthengine_python)
ee_check_python(quiet = F)
ee_check_python_packages(quiet = F)
if (!is.null(user)) {
ee_check_credentials(quiet = quiet)
}
ee_Initialize(project = "ee-hhakk2024")
use_python("C:/Users/Henry/Documents/r-miniconda/")
library(reticulate)
use_python("C:/Users/Henry/Documents/r-miniconda/")
library(rgee)
library(googledrive)
library(remotes)
### INSTALL SECCTION
# Get the username
HOME <- Sys.getenv("HOME")
Sys.setenv("RETICULATE_PYTHON" = "C:/Users/Henry/Documents/r-miniconda")
#C:\Users\Henry\AppData\Local\r-miniconda\envs\r-reticulate
Sys.setenv("EARTHENGINE_GCLOUD" = "C:/Users/Henry/AppData/Local/Google/Cloud SDK")
earthengine_python <- Sys.getenv("EARTHENGINE_PYTHON", unset = NA)
earthengine_python
reticulate::py_config()
python_version = "3.10"
use_python("C:/Users/Henry/Documents/r-miniconda/")
library(reticulate)
use_python("C:/Users/Henry/Documents/r-miniconda/")
library(rgee)
library(googledrive)
library(remotes)
library(rgee)
library(reticulate)
use_python("C:/Users/Henry/Documents/r-miniconda/")
library(taxize)
install.packages("taxize")
library(taxize)
get_iucn("Fratercula arctica")
?get_iucn
oil_taxon_metacoder <- extract_taxonomy("Fratercula arctica", key = "name", database = "ncbi",
allow_na = TRUE)
?extract_taxonomy
oil_taxon_metacoder <- classification("Fratercula arctica", db = "ncbi")
?classification
oil_taxon_metacoder <- classification("Fratercula arctica", db = "itis")
oil_taxon_metacoder
oil_taxon_metacoder <- classification("Fratercula arctica", db = "gbif")
oil_taxon_metacoder]
oil_taxon_metacoder
rl_use_iucn()
library("rredlist")
rl_use_iucn()
edit_r_environ())
edit_r_environ()
usethis::edit_r_environ()
rl_use_iucn()
library(rjags)
library(R2jags)
library(coda)
library(rjags)
?days_in_month
??days_in_month
library(lubridate)
dlist<-paste0(c(2069:2098), "-", 1:12, "-01")
dlist
ndays_c<-seq(from = "2069-01-01", to = "2098-12-31", by = 'day')
ndays_c<-seq(from = as.Date("2069-01-01"), to = as.Date("2098-12-31"), by = 'day')
ndays_c
ndays_c<-length(seq(from = as.Date("2069-01-01"), to = as.Date("2098-12-31"), by = 'day'))
ndays_c
ndays_c<-length(seq(from = as.Date("1991-01-01"), to = as.Date("2020-12-31"), by = 'day'))
ndays_c
grepl("29-02", ndays_c)
grepl("29-02", as.character(ndays_c))
grepl("02-29", as.character(ndays_c))
grepl("02-29", ndays_c)
grepl("02-28", ndays_c)
grepl(ndays_c, v)
grepl(ndays_c,"02-28")
grepl("02-28", seq(from = as.Date("1991-01-01"), to = as.Date("2020-12-31"), by = 'day'))
sum(grepl("02-28", seq(from = as.Date("1991-01-01"), to = as.Date("2020-12-31"), by = 'day')))
sum(grepl("02-29", seq(from = as.Date("1991-01-01"), to = as.Date("2020-12-31"), by = 'day')))
dlist<-paste0(c(2069:2098), "-", 1, "-01")
ndays<-sum(days_in_month(dlist))
ndays
mlist_br<-c(4:9)
mlist_nb<-c(1:3, 10:12)
#quick count for number of days in historical breeding, per season
ndays_br_c<-0
for(m1 in mlist_br){
dlist<-paste0(c(1991:2020), "-", m1, "-01")
ndays<-sum(days_in_month(dlist))
ndays_br_c<-ndays_br_c+ndays
}
ndays_nb_c<-0
for(m1 in mlist_nb){
dlist<-paste0(c(1991:2020), "-", m1, "-01")
ndays<-sum(days_in_month(dlist))
ndays_nb_c<-ndays_nb_c+ndays
}
#quick count for number of days in historical breeding, per season
ndays_br_f<-0
for(m1 in mlist_br){
dlist<-paste0(c(2069:2098), "-", m1, "-01")
ndays<-sum(days_in_month(dlist))
ndays_br_f<-ndays_br_f+ndays
}
ndays_nb_f<-0
for(m1 in mlist_nb){
dlist<-paste0(c(2069:2098), "-", m1, "-01")
ndays<-sum(days_in_month(dlist))
ndays_nb_f<-ndays_nb_f+ndays
}
ndays_c<-length(seq(from = as.Date("1991-01-01"), to = as.Date("2020-12-31"), by = 'day'))
ndays_f<-length(seq(from = as.Date("2069-01-01"), to = as.Date("2098-12-31"), by = 'day'))
ndays_c
ndays_br_c
ndays_nb_c
ndays_f
ndays_br_f
ndays_nb_f
require(raster)
require(xts)
require(zoo)
###
# load raster-stacks exported from the Google Earth Engine
###
# set working directory
setwd("C:/Users/henry.hakkinen/OneDrive - Zoological Society of London/Documents/Research/ZSL/AXA/CleanedData/GEEexports")
mod_ndvi <- brick("MODIS_all_00_20_sm.tif")
setwd("C:/Users/henry.hakkinen/OneDrive - Zoological Society of London/Documents/Research/ZSL/AXA/CleanedData/GEEexports")
110/22
203/5
47*5
110/5
140/5
181/5
36/7
21*5
5*7
38*5
181/5
36.2/7
5*35
35*3
36*5
140/5
/7
28/7
View(C4R)
33+0.2
33.2/2
0.2*5*52
33*5*52
0.2/1000*5*52
33/1000*5*52
0.05*200
8.58*200
0.233*8.58
0.233*0.05
0.42+33
33.42/2
17/1000*5*52
4.42*200
0.233*884
17/1000*5*52
4.42*200
8.58*200
0.233*884
0.233*48
17/1000*5*52
4.42*200
0.233*884/1000
0.233*884/1000
18+140+51+12+9+16+0.2
0.2/246.2
0.2/246.2*100
17/1000*20*52
17/1000*20*52
17.68*200
0.233*3536/1000
3/1000/1000
1/1000*5*52*200
0.38*3536/1000
0.18*3536/1000
0.38*3536/1000
17.68*200
4.42*200 #884
0.18*884/1000
0.38*884/1000
17/1000*10*52
17/1000*10*52
8.84*200 #884
17/1000*10*52
17/1000*10*52
17/1000*10*52
8.84*200 #1768
0.18*1768/1000
0.38*1768/1000
0.3/246.2*100
0.7/246.2*100
17/1000*10*52
8.84*200 #1768
rm(list=ls())
#set your working directory
#I'm lazy so I autodetect where this file is and set it one level higher
#if this fails for any reason, set setwd manually to the folder path
curpath<-dirname(rstudioapi::getSourceEditorContext()$path)
curpath
setwd(curpath)
#go up a level out of the code folder for neatness
setwd("../")
#load packages
source("./code/0Packages.R")
#INTRODUCTION
#there are occasions when we may wish to consider several models and make informed choices between them
#if we only have a pair of models, then a simple anova() or lrtest() are enough to compare them
#but what if we have lots of potential models (e.g. based on different distributions?
#what if we have lots of parameters, and can't (or shouldn't) include all of them?
#in this case we may need ways of comparing models easily
#these often rely on information criteria such as AIC (or AICc for small sample sizes)
#or similar
#in these cases we explore how well they explain the data, and compare AIC scores
#the lower the better.
#remember though that AIC is relative!! It is an estimator of prediction error
#your "best" model may still be terrible
#so always look at residuals, plots and summaries as well
#############
### BACKWARD ELIMINATION
#############
#IMPORTANT NOTE: this whole section is not particularly recommended!
#I have included it because it is a very common approach, and you are likely to see it in the literature!
#in this approach we start with a complex model and try to cut out anything superfluous
#this is a bit of "throwing everything at the wall and see what sticks"
#it is nevertheless a very popular approach
#BUT it is prone to errors, as we are essentially trawling for patterns
#a good rule of thumb: if you have no idea what a correlation would mean if you find one, DON'T PUT that variable in the model
#read data in
mammalsc<-read.csv("Data/mammalsc.csv")
head(mammalsc)
#a very popular way a few years ago was to start with a complex model and work back
#we use AIC comparison to remove anything that doesn't aid the model
#remember we are tempting errors by doing this!
#also if we have covarying variables, then the order we drop is REALLY important
#this is typically not account for, so again errors can creep in
MASS::stepAIC(lm(total_sleep ~ life_span + gestation + log(brain_wt) +
log(body_wt) + predation + exposure + danger, data=mammalsc))
#the final model has the lowest AIC: total_sleep ~ log(brain_wt) + predation + exposure + danger
#a stronger approach is an "augmented" backwards elimination
#this penalises removing parameters that influence other parameters (e.g. through co-variation)
fullmodel <- lm(total_sleep ~ life_span + gestation + log(brain_wt) +
log(body_wt) + predation + exposure + danger, data=mammalsc,
x = TRUE, y = TRUE)
abe(fullmodel, criterion="AIC", verbose = TRUE, exp.beta = FALSE, data=mammalsc)
#our final model: total_sleep ~ life_span + gestation + log(brain_wt) + log(body_wt) + predation + exposure + danger
#variables that, when dropped, lead to increases in AIC are “blacklisted” and therefore not considered for potential exclusion
#in this case we didn't actually remove any parameters!
#we can loosen the assumptions of this test, and set a threshold for AIC change
abe(fullmodel, criterion="AIC", verbose = TRUE, exp.beta = FALSE, tau= 0.1, data=mammalsc)
#new best model: total_sleep ~ gestation + log(brain_wt) + predation + exposure + danger
#now we've dropped a few parameters which are *mostly* not important
#############
### MODEL AVERAGING
#############
#another (better) approach is to average all your potential models
#weighted by performance
#this should account for variation across models, while still favouring the better ones
#and removes the need to select a single "best" model
#this approach is used very commonly in spatial analysses and climate models
#where consensus across models is more important than a single "best" prediction
options(na.action = "na.fail")
fullmodel<-lm(total_sleep ~ life_span + gestation + log(brain_wt) +
log(body_wt) + predation + exposure + danger, data=mammalsc)
allsubsets <- dredge(fullmodel)
allsubsets
#this has made all possible models, and saved how good they are
#then we average them
modaverage <- model.avg(allsubsets, subset = delta < 4)
summary(modaverage)
#full average includes 0's for parameters where they are dropped from models
#conditional average only uses values for parameters from models in which they were retained
#The former is generally better, as it shows which variables trend towards 0 (i.e. are unimportant)
#this is known as parameter shrinkage
# pull off average coefficients and their SEs
avecoef <- (summary(modaverage))$coefmat.full
#reorder terms so they appear the same as in fullmodelsum, below
avecoef <- avecoef[c(1,8,6,3,7,4,5,2),]
fullmodelsum <- broom::tidy(fullmodel)
combinedcoef <- data.frame(coefs = c(avecoef[,1], fullmodelsum$estimate),
se = c(avecoef[,3], fullmodelsum$std.error),
term = as.factor(rep(fullmodelsum$term, 2)),
method = rep(c("Model Average", "Full Model"), each =8))
combinedcoef$upci <- combinedcoef$coefs + 1.96*combinedcoef$se
combinedcoef$loci <- combinedcoef$coefs - 1.96*combinedcoef$se
ggplot(combinedcoef, aes(method, coefs)) + geom_point()+
geom_errorbar(aes(ymin = loci, ymax = upci, width = 0.2)) +
facet_wrap(~term, scales="free") +theme_bw()
#and there are our parameter averages!
#we can see from this that our model averages vary in some case from the "full" model
#this can happen for a variety of reasons, including co-variation, lack of degrees of freedom, interactions etc.
#in this case model averaging has given us a better sense on what our parameters should be based on all available models
#############
### REGULARISATION AND PENALISATION
#############
# AKA the LASSO (Least Absolute Shrinkage and Selection Operator) and ridge regression.
# in this approach, our LASSO attempts to shrink unimportant variables to 0
# this allows us to at least try all variables in a model
# but also to maximise degrees of freedom for the important variables, while minimising the less important ones
# if a variable shrinks to 0, it probably isnt important so is excluded from the model
mammalsc$logbrain_wt<-log(mammalsc$brain_wt)
mammalsc$logbody_wt<-log(mammalsc$body_wt)
x = as.matrix(mammalsc[, c("life_span", "gestation", "logbrain_wt",
"logbody_wt", "predation", "exposure", "danger")])
fitlasso <- glmnet(x = x,
y= mammalsc$total_sleep, alpha=1)
plot(fitlasso, xvar = "lambda", label = TRUE)
#the main parameter for LASSO is the "lambda" parameter
#lamda is our parameter for penalising variables. If it's too low, then it does nothing and retains all variables
#if it's too high, it lowers everything to 0!
#so we obviously need to find a middle ground, one that optimises the model
#we can train a model to look for the optimum value of lamda
cvfit.lasso <- cv.glmnet(x = x,
y= mammalsc$total_sleep, alpha=1)
plot(cvfit.lasso)
#we want the smallest MSE!
#we can extract this
cvfit.lasso$lambda.min
#and use it to find out what our best parameter estimates are
coef(cvfit.lasso, s="lambda.min")
#many variables have been reduced to 0, but we see that gestation, logbrain weight and danger are retained!
#the issue with this approach is you don't get the full model output
#if the model fits badly, you will simply be left with the "least bad model"
#you also don't get standard errors or confidence intervals
#so not that desirable as a way to build predictions or plot your data
#BUT it's a good way to explore your data and build a set of sensible parameters
#to include in a final "standard" GLM!
